# 内核架构

FTL OS的架构如下：

<img src="pic/FTL OS架构.png" alt="FTL OS架构" style="zoom:70%;" />

FTL OS采用无栈异步架构，所有线程都运行在所属CPU的唯一的栈上，这个栈也就是内核初始化时的栈。由于栈的数量就是CPU的数量，FTL OS可以将栈的大小设置得非常大。

FTL OS使用统一的调度器来一视同仁地管理用户线程和内核线程，目前内核线程只被文件系统使用，用于向磁盘异步地同步数据。

FTL OS采用1-1内核线程模型，每个用户线程都拥有一个内核线程的映射，多线程下可以充分利用多核加速。用户线程在内核态中具有两种状态：快速处理路径的同步状态和运行于无栈协程的异步状态。大多数情况中只需要快速处理路径就能够完成全部的处理，少数情况下会回到异步状态。快速处理路径本质上是异步状态下调用的一个函数，和异步状态共享同一个栈，不需要另外分配的栈空间。

共享页预读系统用来提前从文件的共享页复制数据到一块未使用的内存中，通过将复制转移到其他核心的方式显著地提升了写请求缺页错误的处理速度。

