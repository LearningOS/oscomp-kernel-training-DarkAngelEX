# 内核设计

FTL OS是RISC-V 64平台上的高性能多核异步宏内核操作系统，完全从零开始开发，部分代码借鉴自清华大学的rCore-tutorial。正如FTL超越光速之意，**FTL OS将性能作为第一目标**，性能与多核安全是FTL OS开发的绝对重心。FTL OS将竭尽所能地将性能优化到极致，在性能、功能、安全、稳定性上都达到现代操作系统的水平，并维持代码的可读性，能够在未来有参考价值。

FTL OS 开发过程并不是完全循序渐进的迭代开发，而是完成阶段性架构设计后一次性进行完整的代码编写，将重构放在了设计阶段。也正因为如此FTL OS在预开发阶段抛弃了rCore-tutorial，因为尽管rCore-tutorial作为一个教学操作系统是非常成功的，但rCore-tutorial没有为多核运行作任何的考量，这一点甚至不如xv6。由于FTL OS的多核安全从立项开始就放置在了最高优先级，而为rCore-tutorial添加多核的补丁的工作量太大且可能忽略许多细节，这也是FTL OS选择从零开发的原因。归零后编程语言也可以重新选择了，FTL OS依然选择了rust语言。这并不是随大流，下面将说明放弃C/C++的部分原因：

1. C/C++无法使用原始libc库，如果要从零开发需要造非常多的轮子，而且性能低下。例如memcpy函数，xv6中的实现是使用for循环逐字节复制，但这其实是很低效的，当地址对齐到8字节时可以用ld/sd指令一次复制8个字节，相比原始实现**性能提高8倍**！如果支持向量指令集还可以更快。你费尽心血应用了一大堆复杂的优化，另一个队简单重写了memcpy就比你快了！这样的优化还有很多，阅读libc的源码可以有更深的理解。
2. C语言基于goto的错误处理机制**常人难以驾驭**，C++开创性的RAII机制改善了资源的回收，但基于栈回退的异常的错误处理性能极差且阻碍优化，而基于错误码的错误处理非常繁琐。
3. C语言是彻底的静态语言，类型系统孱弱无比，宏是唯一批量生成重复代码的手段，因此所有数据结构都强制使用危险的侵入式数据类型。C++提供了强大的模板来生成代码，但每个编译单元都需要独立编译，编译速度非常缓慢。
4. 声明与实现分离的分离编译。C语言的这一设计是早期编译平台性能不足导致的，它可以提高编译速度，但也非常严重地阻碍了编译器内联，需要繁琐的方式来解决它。也正因如此，C/C++之后所有语言采用了模块的方式编译，C++20也加入了module。
5. C/C++没有提供slice抽象，特别是字符串，全世界的编程语言中字符串通过结束符终止的仅此两家，除了效率低下外也带来了无数安全性的问题。C++20加入了span改善了这一问题，但比赛的编译器不支持C++20。

以上问题替换为rust就可以解决了吗？rust正式版于2015年上线，避免了许多语言的弯路。rust相比C/C++可以：

1. 提供了no_std下依然可以使用的core库，不用手写memcpy了。
2. 基于模式匹配的和类型错误处理，处理过程流畅无比。基于所有权的析构函数，所有权转移后不会调用析构函数（C++的析构函数必定执行）。
3. 基于trait的泛型机制，强大的类型匹配系统。
4. 基于模块的编译，函数显式声明为inline后在所有编译单元可见。
5. 基于slice于所有权的内存管理，不使用unsafe能够保证绝对内存安全。
6. 完善的cargo包管理工具，通过版本号可以保证编译稳定性。

以上就是FTL OS采用rust的部分原因。

首次接触无栈异步架构是在调研2021届操作系统大赛时发现的华中科技大学无相之风团队开发的飓风内核，飓风内核是操作系统功能赛道二等奖作品，使用运行在用户态的共享调度器完成调度，上下文切换速度极快。一开始我们甚至认为它是内核赛道作品，直到发现了它没有fork，遂放弃。接下来是偶然发现的rCore，那`async`关键字如同闪光弹在脑中炸开，FTL OS也从此开始确定使用了无栈协程架构。无栈上下文切换具有更高的速度，所有涉及上下文切换的函数都必须显示使用`await`标识，编译器可以看到所有上下文切换的位置。目前无栈上下文切换的主要缺点是编译速度奇慢无比，目前其他队伍的编译时间大约为3秒，而FTL OS的编译时间已经来到了1分钟，增量编译时间约20秒，可以预测未来编译时间会更长。不像有栈协程需要为每个任务分配一个栈空间且在浪费空间和栈溢出二选一，无栈协程最显著的优点就是程序运行时需要的内存大小是编译时确定的，在分配任务时被一次性分配内存，任务运行时绝对不会出现空间不足或空间过剩。目前无栈协程已经被大规模应用在了软件开发中且有了替代有栈协程的趋势，C++20也历史性地加入了无栈协程的编译器支持。

UltraOS是2021届操作系统大赛内核赛道一等奖作品，它设计给了我们许多启发，使我们可以站在巨人的肩膀上。但阅读源码我们也可以发现，UltraOS的许多设计是针对K210平台运行的，大量的设计与优化是针对K210 6MB的内存限制，但这样小的内存基本只出现在嵌入式芯片中，而且严重限制了操作系统。Hifive Unmatched平台提供了16GB的内存，这为FTL OS的开发提供了许多强力后盾。K210只有2个核心，因此多核竞争问题并不严重，但Hifive Unmatched提供了4个核心，因此如UltraOS一样大面积地使用全局锁会限制多核的施展。FTL OS的一个优化重心就是限制锁的作用域，将锁竞争降低到最低。

经过充分优化的现代操作系统是如何运行的？开源的Linux是一个绝佳的老师。但由于Linux经过了多年发展已经高度复杂，FTL OS对Linux的借鉴仅限于运行逻辑与优化算法。Linux的设计确实精妙，每次阅读源码都会被它高效的实现震撼。FTL OS会尝试将Linux内的系统以更高效简洁的方式在FTL OS中实现。

初赛阶段临近结束，FTL OS目前已经实现了：

* 无栈异步架构，完善的多核设计。
* 27条POSIX规范的系统调用。
* 完全解耦的映射页管理器，一步到位地管理共享映射。
* 完全符合FAT32标准的高性能并行异步文件系统。
* 带CRC纠错的SPI协议SD卡驱动。
* 异步运行的栈回退调试系统。

