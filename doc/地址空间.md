# 地址空间

# 虚拟内存划分

一共39位地址，高25位需要和第39位相同。利用高位0/1划分为用户区和内存区

两个区域的地址空间都是256GiB，根本用不完。

## 内核区

[0xffff_ffc0_0000_0000, 0xffff_ffff_ffff_ffff]

将0xffff_ffc0_0000_0000作为基址KERNEL_BASE(KB)，同[KB,KB+0x40_0000_0000)

整个内核段的TLB使用了G标志位，永不清除。

### Trampoline 0xffff_ffff_ffff_f000 [弃用]

内核区最高位地址，作为进入内核段的跳板。然而全局映射下不需要再映射一页。

### 硬件IO地址 ~1GB 0xffff_ffff_c000_0000 - 0xffff_ffff_ffff_f000

CLINT PLIC VIRTIO0 UART0

### Kernel text/data 1GB 0xffff_ffff_8000_0000 - 0xffff_ffff_c000_0000

内核代码段 需要区分text readonly

1GB需要~256KB页表，视情况改变区域大小，xv6为128MB, 32KB页表

#### INIT_MEMORY_END = KERNEL_TEXT_BEGIN + 8MB

内部地址空间，从end到这个地址被分配到页分配器。

需要保证内核自身数据用到的空间比这个值小。

### 直接内存映射 32GB 0xffff_fff0_0000_0000 - 0xffff_fff8_0000_0000

映射至整个物理内存，放置了数据段，代码段等。

这个段的标志位为RW，不可执行代码，但可以通过这个段直接修改内核代码。

这个段使用了32个1GB的巨页表映射到物理内存，转换极快。

指针引用：kernel stack, trapframe

所有内核段数据都被重新映射到了这里，分界线为 MEMORY_INIT_KERNEL_END。

使用PhyAddrRef与PhyAddrRef引用这个段的指针。

整个内存区使用buddy分配器管理。

### MMAP 64GB 0xffff_ffd0_0000_0000 - 0xffff_ffe0_0000_0000

MMAP

### ？虚拟内存映射 64GB 0xffff_ffc0_0000_0000 - 0xffff_ffd0_0000_0000

写入磁盘的内存映射 保留

### KernelBase 0xffff_ffc0_0000_0000

最低内核地址 保留

## 用户区

[0x0, 0x40_0000_0000)

### 链接基地址BASE_ADDRESS 0x10000

之前的的地址都是无效的。

基地址不需要非这个数不可，但不能是0。

### 应用数据段 32GB 0x10000 - 0x8_0000_0000

.text 代码段

.rodata 只读段

.data 从应用中加载的数据段

.bss 初始为0的数据段

包含了IO缓冲区，由运行库加载到静态区而不是动态分配。

### 堆段 32GB 0x8_0000_0000 - 0x10_0000_0000

全局动态内存分配区

### 线程栈段 64GB 0x10_0000_0000 - 0x20_0000_0000

默认每个线程占有4MB空间，以懒分配方式分配空间，最大数量为16M = 16384。

### MMAP 128GB 0x20_0000_0000 - 0x40_0000_0000

文件映射区

### 最高地址 0x40_0000_0000

最高地址

## MAGIC物理地址 硬件使用

PLIC

## Linux x64

![](https://docimg10.docs.qq.com/image/rTYzeEBrcYB1Dsi595DlwQ.png?w=409&h=634)

## 华科xv6-k210样例

注意，最终代码里以下布局Trapframe和Kernel Stack根本没有放入页表，而是直接使用动态内存区裸指针。栈溢出检测别想了。





## xv6样例

内核虚拟地址

![](https://docimg9.docs.qq.com/image/zqUQQKS3Ur0A89WtP9mQ4g.png?w=272&h=584)

用户虚拟地址

![](https://docimg4.docs.qq.com/image/2pMpDh03gAm5RAULgCmv7w.png?w=1039&h=927) ![](https://docimg1.docs.qq.com/image/TMKlhyqWFvr5_I4uJ2xIJg.png?w=1280&h=838.2475019215988)======