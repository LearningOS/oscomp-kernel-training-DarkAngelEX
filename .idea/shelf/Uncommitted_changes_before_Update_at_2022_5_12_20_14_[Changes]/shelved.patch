Index: code/kernel/Makefile
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+># Building\nARCH ?= riscv64\nTARGET := riscv64imac-unknown-none-elf\nMODE := debug\nADD_ARGS :=\nARGS :=\nARGS += $(ADD_ARGS)\n\nKERNEL_ELF := target/$(TARGET)/$(MODE)/kernel\nKERNEL_BIN := $(KERNEL_ELF).bin\nDISASM_TMP := target/$(TARGET)/$(MODE)/asm\n# FS_IMG := ../user/target/$(TARGET)/$(MODE)/fs.img\nFS_IMG := ../user/target/$(TARGET)/release/fs.img\nFS_IMG_BUILD := ../fat32-fuse\nFS_IMG_SRC := ../fat32-fuse/fat32.img\nSDCARD := /dev/sdb\nAPPS := ../user/src/bin/*\n\nSMP := 4\nMEMORY_SIZE := 128M\n\n# BOARD\nBOARD ?= qemu\nSBI ?= rustsbi\nBOOTLOADER := ../bootloader/$(SBI)-$(BOARD).bin\nK210_BOOTLOADER_SIZE := 131072\n\n# KERNEL ENTRY\nifeq ($(BOARD), qemu)\n\tKERNEL_ENTRY_PA := 0x80200000\nelse ifeq ($(BOARD), k210)\n\tKERNEL_ENTRY_PA := 0x80020000\nendif\n\n# Run K210\nK210-SERIALPORT\t= /dev/ttyUSB0\nK210-BURNER = ../tools/kflash.py\n\n# Binutils\nOBJDUMP := rust-objdump --arch-name=riscv64\nOBJCOPY := rust-objcopy --binary-architecture=riscv64\n\n# Disassembly\nDISASM ?= -x\n\nbuild: env switch-check binary\n\nswitch-check:\nifeq ($(BOARD), qemu)\n\t(find last-qemu) || (rm -f last-k210 && touch last-qemu && make clean)\nelse ifeq ($(BOARD), k210)\n\t(find last-k210) || (rm -f last-qemu && touch last-k210 && make clean)\nendif\n\nenv:\n\t(rustup target list | grep \"riscv64imac-unknown-none-elf (installed)\") || rustup target add $(TARGET)\n\tcargo install cargo-binutils --vers =0.3.3\n\trustup component add rust-src\n\trustup component add llvm-tools-preview\n\nsdcard: fs-img\n\t@echo \"Are you sure write to $(SDCARD) ? [y/N] \" && read ans && [ $${ans:-N} = y ]\n\t@sudo dd if=/dev/zero of=$(SDCARD) bs=1048576 count=32\n\t@sudo dd if=$(FS_IMG) of=$(SDCARD)\n\nbinary: kernel\n\t@$(OBJCOPY) $(KERNEL_ELF) --strip-all -O binary $(KERNEL_BIN)\n\t@cp -f $(KERNEL_BIN) ./os.bin\n\nfs-img-prev: $(APPS)\n\t@cd ../user && make build\n\t@rm -f $(FS_IMG)\n#\t@cd ../easy-fs-fuse && cargo run --release -- -s ../user/src/bin/ -t ../user/target/riscv64imac-unknown-none-elf/release/ -o ../user/target/riscv64imac-unknown-none-elf/release/\n#\t@cd ../easy-fs-fuse && cargo run --release -- -s ../user/busybox_lua_testsuites/ -t ../user/busybox_lua_testsuites/ -o ../user/target/riscv64imac-unknown-none-elf/release/\n\nfs-img:\n\t@cd $(FS_IMG_BUILD) && make init\n\t@cp $(FS_IMG_SRC) $(FS_IMG)\n\n$(APPS):\n\nkernel:\nifeq ($(ARCH), riscv64)\nifeq ($(BOARD), qemu)\n\t@echo Platform: qemu\n\t@cp src/hart/boot/linker64.ld src/linker.ld\nifeq ($(MODE), release)\n\t@cargo build --release $(ARGS)\nelse\n\tcargo build $(ARGS)\nendif\n\t@rm src/linker.ld\nendif\nendif\n\n\ntake_bin: binary\n\nclean:\n\t@cargo clean\n\ndisasm: kernel\n\t@$(OBJDUMP) $(DISASM) $(KERNEL_ELF) | less\n\ndisasm-vim: kernel\n\t@$(OBJDUMP) $(DISASM) $(KERNEL_ELF) > $(DISASM_TMP)\n\t@vim $(DISASM_TMP)\n\t@rm $(DISASM_TMP)\n\nrun: run-inner\n\n\n\nrun-inner: build\nifeq ($(BOARD),qemu)\n\t@qemu-system-riscv64 \\\n\t\t-machine virt \\\n\t\t-nographic \\\n\t\t-smp $(SMP) \\\n\t\t-bios $(BOOTLOADER) \\\n\t\t-m $(MEMORY_SIZE) \\\n\t\t-device loader,file=$(KERNEL_BIN),addr=$(KERNEL_ENTRY_PA) \\\n\t\t-drive file=$(FS_IMG),if=none,format=raw,id=x0 \\\n        -device virtio-blk-device,drive=x0,bus=virtio-mmio-bus.0\nelse\n\t(which $(K210-BURNER)) || (cd .. && git clone https://github.com/sipeed/kflash.py.git && mv kflash.py tools)\n\t@cp $(BOOTLOADER) $(BOOTLOADER).copy\n\t@dd if=$(KERNEL_BIN) of=$(BOOTLOADER).copy bs=$(K210_BOOTLOADER_SIZE) seek=1\n\t@mv $(BOOTLOADER).copy $(KERNEL_BIN)\n\t@sudo chmod 777 $(K210-SERIALPORT)\n\tpython3 $(K210-BURNER) -p $(K210-SERIALPORT) -b 1500000 $(KERNEL_BIN)\n\tpython3 -m serial.tools.miniterm --eol LF --dtr 0 --rts 0 --filter direct $(K210-SERIALPORT) 115200\nendif\n\ndebug: build\n\t@tmux new-session -d \\\n\t\t\"qemu-system-riscv64 -machine virt -nographic -bios $(BOOTLOADER) -device loader,file=$(KERNEL_BIN),addr=$(KERNEL_ENTRY_PA) -s -S\" && \\\n\t\ttmux split-window -h \"riscv64-unknown-elf-gdb -ex 'file $(KERNEL_ELF)' -ex 'set arch riscv:rv64' -ex 'target remote localhost:1234'\" && \\\n\t\ttmux -2 attach-session -d\n\n.PHONY: build env kernel clean disasm disasm-vim run-inner switch-check\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/code/kernel/Makefile b/code/kernel/Makefile
--- a/code/kernel/Makefile	(revision 3af1f2e3a64142533bd04f4258cfed8659b4bc20)
+++ b/code/kernel/Makefile	(date 1652355087755)
@@ -16,7 +16,7 @@
 SDCARD := /dev/sdb
 APPS := ../user/src/bin/*
 
-SMP := 4
+SMP := 1
 MEMORY_SIZE := 128M
 
 # BOARD
